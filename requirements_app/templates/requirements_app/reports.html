{% extends "requirements_app/admin_template.html" %}
{% load custom_tags %}

{% block title %}Reports - E-Parliament Bangladesh{% endblock %}

{% block custom_styles %}
.report-section {
    margin-bottom: 2rem;
}
.report-card {
    border-radius: 10px;
    border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: all 0.3s;
    margin-bottom: 1.5rem;
    height: 100%;
}
.report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.nav-pills .nav-link {
    border-radius: 0.5rem;
    padding: 0.75rem 1.25rem;
    margin-right: 0.5rem;
    font-weight: 500;
}
.nav-pills .nav-link.active {
    background-color: #28a745;
}
.filter-section {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #28a745;
}
.table th {
    background-color: #28a745;
    color: white;
}
.report-title {
    border-left: 5px solid #28a745;
    padding-left: 15px;
}
.print-btn {
    position: absolute;
    top: 10px;
    right: 10px;
}
@media print {
    .no-print {
        display: none !important;
    }
    .print-only {
        display: block !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    .table th {
        background-color: #f2f2f2 !important;
        color: #000 !important;
    }
}
.excel-section {
    background-color: #e8f5e9;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 5px solid #28a745;
}
{% endblock %}

{% block main_content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-file-alt text-primary me-2"></i>System Reports</h2>
            <div>
                <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                </a>
            </div>
        </div>
        <p class="text-muted">Generate and view system reports</p>
    </div>
</div>

<!-- Excel Export Section -->
<div class="card excel-section shadow-sm no-print mb-4">
    <div class="card-body">
        <h5><i class="fas fa-file-excel me-2 text-success"></i>Excel Report Download</h5>
        <p>Generate a comprehensive Excel report containing all form responses for selected users.</p>
        
        <form id="excelDownloadForm" action="{% url 'download_excel_report' %}" method="get" class="mt-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label for="excelUserIds" class="form-label">User IDs (comma-separated)</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="excelUserIds" name="user_ids" placeholder="e.g., 110100091, 110100092">
                        <button type="button" class="btn btn-outline-success" id="selectAllUsers">Select All</button>
                    </div>
                    <div class="form-text">Enter multiple IDs separated by commas, or click "Select All" to include all users</div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-download me-2"></i> Download Excel Report
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Report Type Navigation Tabs -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <ul class="nav nav-pills mb-4 no-print" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                    <i class="fas fa-users me-2"></i>System Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="forms-tab" data-bs-toggle="pill" data-bs-target="#forms" type="button" role="tab" aria-controls="forms" aria-selected="false">
                    <i class="fas fa-file-alt me-2"></i>Submitted Forms
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="counts-tab" data-bs-toggle="pill" data-bs-target="#counts" type="button" role="tab" aria-controls="counts" aria-selected="false">
                    <i class="fas fa-chart-bar me-2"></i>Counting Based
                </button>
            </li>
        </ul>

        <!-- Report Content -->
        <div class="tab-content" id="reportTabsContent">
            <!-- 1. System Users Report -->
            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 report-title">System Users Report</h5>
                    </div>
                    <div class="card-body">
                        <!-- Filter Options -->
                        <div class="filter-section no-print">
                            <h6><i class="fas fa-filter me-2"></i>Filter Options</h6>
                            <form method="get" action="{% url 'reports' %}" id="userReportForm">
                                <input type="hidden" name="report_type" value="users">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">User Role</label>
                                        <select name="user_role" class="form-select" id="userRoleSelect">
                                            <option value="all" {% if user_role == 'all' %}selected{% endif %}>All Users</option>
                                            <option value="admin" {% if user_role == 'admin' %}selected{% endif %}>Only Admins</option>
                                            <option value="user" {% if user_role == 'user' %}selected{% endif %}>Only Regular Users</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">Generate Report</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Report Results -->
                        {% if user_report %}
                        <div class="report-result">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>{{ user_report_title }}</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-2 no-print copy-to-excel" data-target="userTable">
                                        <i class="fas fa-copy me-1"></i> Copy IDs to Excel Form
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary print-btn no-print" onclick="window.print()">
                                        <i class="fas fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Print header - only visible when printing -->
                            <div class="d-none print-only text-center mb-4">
                                <h3>E-Parliament Bangladesh</h3>
                                <h5>{{ user_report_title }}</h5>
                                <p>Generated on: {% now "F d, Y H:i" %}</p>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped" id="userTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 5%">SL.</th>
                                            <th scope="col" style="width: 15%">ID</th>
                                            <th scope="col" style="width: 20%">Name</th>
                                            <th scope="col" style="width: 20%">Designation</th>
                                            <th scope="col" style="width: 15%">Wing</th>
                                            <th scope="col" style="width: 15%">Department</th>
                                            <th scope="col" style="width: 10%">Role</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in user_report %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.get_full_name }}</td>
                                            <td>{{ user.designation }}</td>
                                            <td>{{ user.wing_name }}</td>
                                            <td>{{ user.department_name }}</td>
                                            <td>{{ user.get_role_display }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center">No users found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="7" class="text-end">
                                                <strong>Total: {{ user_report|length }} user(s)</strong>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Print footer - only visible when printing -->
                            <div class="d-none print-only text-center mt-4">
                                <p>Generated by: {{ request.user.get_full_name }}</p>
                                <p>© {% now "Y" %} E-Parliament Bangladesh - Software Development Section, B&IT Wing</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i> Select filter options and generate the report
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 2. Submitted Forms Report -->
            <div class="tab-pane fade" id="forms" role="tabpanel" aria-labelledby="forms-tab">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 report-title">Submitted Forms Report</h5>
                    </div>
                    <div class="card-body">
                        <!-- Filter Options -->
                        <div class="filter-section no-print">
                            <h6><i class="fas fa-filter me-2"></i>Filter Options</h6>
                            <form method="get" action="{% url 'reports' %}" id="formsReportForm">
                                <input type="hidden" name="report_type" value="forms">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Report By</label>
                                        <select name="form_filter_type" class="form-select" id="formFilterTypeSelect">
                                            <option value="wing" {% if form_filter_type == 'wing' %}selected{% endif %}>Wing-Wise</option>
                                            <option value="user" {% if form_filter_type == 'user' %}selected{% endif %}>User-Wise</option>
                                            <option value="process" {% if form_filter_type == 'process' %}selected{% endif %}>Process-Wise</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Wing-wise filter options -->
                                    <div class="col-md-8 filter-wing" {% if form_filter_type != 'wing' and form_filter_type %}style="display:none"{% endif %}>
                                        <label class="form-label">Select Wings</label>
                                        <div class="row">
                                            <div class="col-md-9">
                                                <select name="selected_wings" class="form-select" multiple size="3">
                                                    <option value="all" {% if 'all' in selected_wings %}selected{% endif %}>All Wings</option>
                                                    {% for wing in available_wings %}
                                                        <option value="{{ wing.wing_name }}" {% if wing.wing_name in selected_wings %}selected{% endif %}>
                                                            {{ wing.wing_name }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <small class="text-muted">Hold Ctrl/Cmd to select multiple wings</small>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="d-grid h-100">
                                                    <button type="submit" class="btn btn-primary">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- User-wise filter options -->
                                    <div class="col-md-8 filter-user" {% if form_filter_type != 'user' %}style="display:none"{% endif %}>
                                        <label class="form-label">Select Users</label>
                                        <div class="row">
                                            <div class="col-md-9">
                                                <select name="selected_users" class="form-select" id="userSelect">
                                                    <option value="all" {% if selected_users == 'all' %}selected{% endif %}>All Users</option>
                                                    <option value="custom" {% if selected_users == 'custom' %}selected{% endif %}>Custom Users</option>
                                                </select>
                                                <div class="mt-2 custom-users-input" {% if selected_users != 'custom' %}style="display:none"{% endif %}>
                                                    <input type="text" name="custom_user_ids" class="form-control" placeholder="Enter user IDs separated by commas" value="{{ custom_user_ids }}">
                                                    <small class="text-muted">Example: 110100091, 110100092</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="d-grid h-100">
                                                    <button type="submit" class="btn btn-primary">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Process-wise filter options -->
                                    <div class="col-md-8 filter-process" {% if form_filter_type != 'process' %}style="display:none"{% endif %}>
                                        <label class="form-label">Process Name</label>
                                        <div class="row">
                                            <div class="col-md-9">
                                                <input type="text" name="process_name" class="form-control" placeholder="Enter process name" value="{{ process_name }}">
                                                <small class="text-muted">For multiple processes, separate with commas</small>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="d-grid h-100">
                                                    <button type="submit" class="btn btn-primary">Generate</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Report Results -->
                        {% if forms_report %}
                        <div class="report-result">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>{{ forms_report_title }}</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-2 no-print copy-to-excel" data-target="formsTable">
                                        <i class="fas fa-copy me-1"></i> Copy IDs to Excel Form
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary print-btn no-print" onclick="window.print()">
                                        <i class="fas fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Print header - only visible when printing -->
                            <div class="d-none print-only text-center mb-4">
                                <h3>E-Parliament Bangladesh</h3>
                                <h5>{{ forms_report_title }}</h5>
                                <p>Generated on: {% now "F d, Y H:i" %}</p>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped" id="formsTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 5%">SL.</th>
                                            <th scope="col" style="width: 15%">User ID</th>
                                            <th scope="col" style="width: 20%">User Name</th>
                                            <th scope="col" style="width: 20%">Process Name</th>
                                            <th scope="col" style="width: 15%">Wing</th>
                                            <th scope="col" style="width: 15%">Submitted Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for form in forms_report %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ form.user.username }}</td>
                                            <td>{{ form.user.get_full_name }}</td>
                                            <td>{{ form.process_name }}</td>
                                            <td>{{ form.user.wing_name }}</td>
                                            <td>{{ form.submitted_at|date:"F d, Y" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center">No forms found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="6" class="text-end">
                                                <strong>Total: {{ forms_report|length }} form(s)</strong>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Print footer - only visible when printing -->
                            <div class="d-none print-only text-center mt-4">
                                <p>Generated by: {{ request.user.get_full_name }}</p>
                                <p>© {% now "Y" %} E-Parliament Bangladesh - Software Development Section, B&IT Wing</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i> Select filter options and generate the report
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 3. Counting Based Report -->
            <div class="tab-pane fade" id="counts" role="tabpanel" aria-labelledby="counts-tab">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 report-title">Counting Based Reports</h5>
                    </div>
                    <div class="card-body">
                        <!-- Report Type Selection -->
                        <div class="filter-section no-print">
                            <h6><i class="fas fa-filter me-2"></i>Select Report Type</h6>
                            <form method="get" action="{% url 'reports' %}" id="countsReportForm">
                                <input type="hidden" name="report_type" value="counts">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Count Report Type</label>
                                        <select name="count_report_type" class="form-select">
                                            <option value="wing_count" {% if count_report_type == 'wing_count' %}selected{% endif %}>Wing-Wise Count</option>
                                            <option value="user_participation" {% if count_report_type == 'user_participation' %}selected{% endif %}>User Participation Count</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Participation Status (for User Report)</label>
                                        <select name="participation_status" class="form-select" {% if count_report_type != 'user_participation' %}disabled{% endif %}>
                                            <option value="all" {% if participation_status == 'all' %}selected{% endif %}>All Users</option>
                                            <option value="submitted" {% if participation_status == 'submitted' %}selected{% endif %}>Only Submitted</option>
                                            <option value="not_submitted" {% if participation_status == 'not_submitted' %}selected{% endif %}>Only Not Submitted</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <button type="submit" class="btn btn-primary">Generate Report</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Wing-Wise Count Report -->
                        {% if wing_count_report %}
                        <div class="report-result">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Wing-Wise Requirement Count</h5>
                                <button class="btn btn-sm btn-outline-secondary print-btn no-print" onclick="window.print()">
                                    <i class="fas fa-print me-1"></i> Print
                                </button>
                            </div>
                            
                            <!-- Print header - only visible when printing -->
                            <div class="d-none print-only text-center mb-4">
                                <h3>E-Parliament Bangladesh</h3>
                                <h5>Wing-Wise Requirement Count</h5>
                                <p>Generated on: {% now "F d, Y H:i" %}</p>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 10%">SL.</th>
                                            <th scope="col" style="width: 50%">Wing Name</th>
                                            <th scope="col" style="width: 40%">Number of Requirement</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for wing in wing_count_report %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ wing.user__wing_name|default:"Unspecified" }}</td>
                                            <td>{{ wing.count }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center">No data found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>Total Wings:</strong></td>
                                            <td><strong>{{ wing_count_report|length }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-end"><strong>Total Requirements:</strong></td>
                                            <td><strong>{{ total_requirements }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Print footer - only visible when printing -->
                            <div class="d-none print-only text-center mt-4">
                                <p>Generated by: {{ request.user.get_full_name }}</p>
                                <p>© {% now "Y" %} E-Parliament Bangladesh - Software Development Section, B&IT Wing</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- User Participation Report -->
                        {% if user_participation_report %}
                        <div class="report-result">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>User Participation List</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-success me-2 no-print copy-to-excel" data-target="userParticipationTable">
                                        <i class="fas fa-copy me-1"></i> Copy IDs to Excel Form
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary print-btn no-print" onclick="window.print()">
                                        <i class="fas fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Print header - only visible when printing -->
                            <div class="d-none print-only text-center mb-4">
                                <h3>E-Parliament Bangladesh</h3>
                                <h5>User Participation List</h5>
                                <p>Generated on: {% now "F d, Y H:i" %}</p>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped" id="userParticipationTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 5%">SL.</th>
                                            <th scope="col" style="width: 15%">ID</th>
                                            <th scope="col" style="width: 20%">Name</th>
                                            <th scope="col" style="width: 20%">Designation</th>
                                            <th scope="col" style="width: 15%">Wing</th>
                                            <th scope="col" style="width: 25%">Total Submitted Requirement</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in user_participation_report %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.get_full_name }}</td>
                                            <td>{{ user.designation }}</td>
                                            <td>{{ user.wing_name }}</td>
                                            <td>{{ user.submission_count }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center">No data found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="5" class="text-end"><strong>Total Users:</strong></td>
                                            <td><strong>{{ user_participation_report|length }}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Print footer - only visible when printing -->
                            <div class="d-none print-only text-center mt-4">
                                <p>Generated by: {{ request.user.get_full_name }}</p>
                                <p>© {% now "Y" %} E-Parliament Bangladesh - Software Development Section, B&IT Wing</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if not wing_count_report and not user_participation_report and count_report_type %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i> No data found for the selected report type
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Show the correct tab based on the report type
    document.addEventListener('DOMContentLoaded', function() {
        {% if report_type %}
            // Get the tab based on report type
            const tabId = '{{ report_type }}-tab';
            const tab = document.getElementById(tabId);
            
            if (tab) {
                // Activate the correct tab
                const bsTab = new bootstrap.Tab(tab);
                bsTab.show();
            }
        {% endif %}
        
        // Show/hide filters based on form filter type
        const formFilterSelect = document.getElementById('formFilterTypeSelect');
        if (formFilterSelect) {
            formFilterSelect.addEventListener('change', function() {
                // Hide all filter options
                document.querySelectorAll('.filter-wing, .filter-user, .filter-process').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Show the selected filter options
                const selectedFilter = this.value;
                document.querySelector(`.filter-${selectedFilter}`).style.display = 'block';
            });
        }
        
        // Show/hide custom user input based on selection
        const userSelect = document.getElementById('userSelect');
        if (userSelect) {
            userSelect.addEventListener('change', function() {
                const customUserInput = document.querySelector('.custom-users-input');
                if (this.value === 'custom') {
                    customUserInput.style.display = 'block';
                } else {
                    customUserInput.style.display = 'none';
                }
            });
        }
        
        // Enable/disable participation status select based on count report type
        const countReportSelect = document.querySelector('select[name="count_report_type"]');
        if (countReportSelect) {
            countReportSelect.addEventListener('change', function() {
                const participationSelect = document.querySelector('select[name="participation_status"]');
                participationSelect.disabled = (this.value !== 'user_participation');
            });
        }

        // Handle "Select All" button for Excel export
        const selectAllBtn = document.getElementById('selectAllUsers');
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function() {
                document.getElementById('excelUserIds').value = 'all';
            });
        }

        // Handle "Copy IDs to Excel Form" buttons
        const copyButtons = document.querySelectorAll('.copy-to-excel');
        copyButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Get the target table
                const targetTableId = this.getAttribute('data-target');
                const table = document.getElementById(targetTableId);
                
                if (table) {
                    // Extract user IDs from the table
                    const userIds = [];
                    const rows = table.querySelectorAll('tbody tr');
                    
                    rows.forEach(row => {
                        // Get ID column (2nd column, index 1)
                        const idCell = row.cells[1];
                        if (idCell && idCell.textContent.trim()) {
                            userIds.push(idCell.textContent.trim());
                        }
                    });

                    // Set the IDs to the Excel export form
                    if (userIds.length > 0) {
                        document.getElementById('excelUserIds').value = userIds.join(', ');
                        // Scroll to the Excel export section
                        document.querySelector('.excel-section').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        alert('No user IDs found in the table.');
                    }
                }
            });
        });
    });
</script>
{% endblock %}